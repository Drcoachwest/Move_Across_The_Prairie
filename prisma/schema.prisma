// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Admin {
  id       String   @id @default(cuid())
  username String   @unique
  password String   // bcrypt hash
  name     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("admins")
}

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String?
  password  String?    // bcrypt hash - null until user sets it
  activated Boolean    @default(false)
  activatedAt DateTime?
  activationCodeUsed String? // code that was used to activate
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  lessonPlans LessonPlan[]
  
  @@map("users")
}

model Teacher {
  id        String     @id @default(cuid())
  email     String     @unique
  name      String
  school    String     // School they teach at
  password  String     // bcrypt hash
  activated Boolean    @default(false)
  activatedAt DateTime?
  activationCodeUsed String? // code that was used to activate
  locked    Boolean    @default(false) // Temporary account restriction
  resetToken String?    // Token for password reset
  resetTokenExpiresAt DateTime? // Expiration time for reset token
  
  // School Level Distinction
  schoolLevel String    @default("ELEMENTARY") // ELEMENTARY | SECONDARY
  grade       Int?      // for elementary only (e.g., 3, 4, 5)
  department  String?   // for secondary only (PE, Math, Science, etc.)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  // Relations
  classPeriods ClassPeriod[]
  
  @@map("teachers")
}

model ActivationCode {
  id        String     @id @default(cuid())
  code      String     @unique
  active    Boolean    @default(true)
  expiresAt DateTime?
  maxUses   Int        @default(1)
  usesCount Int        @default(0)
  createdAt DateTime   @default(now())
  createdBy String     // admin username
  
  @@map("activation_codes")
}

model CurriculumResource {
  id          String     @id @default(cuid())
  title       String
  description String?
  band        String     @default("ELEMENTARY") // ELEMENTARY | MIDDLE | HIGH
  grade       String?    // e.g., "K-2", "3-5", "6-8", "9-12"
  unit        String?
  subject     String?
  tags        String?    // comma-separated tags
  type        String     // 'pdf', 'doc', 'link'
  fileUrl     String?
  externalUrl String?
  uploadedAt  DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  createdBy   String     // admin username
  
  lessonPlanResources LessonPlanResource[]
  
  @@map("curriculum_resources")
}

model LessonPlanResource {
  id               String   @id @default(cuid())
  lessonPlanId     String
  lessonPlan       LessonPlan @relation(fields: [lessonPlanId], references: [id], onDelete: Cascade)
  resourceId       String
  resource         CurriculumResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  
  @@unique([lessonPlanId, resourceId])
  @@map("lesson_plan_resources")
}

model LessonPlan {
  id        String     @id @default(cuid())
  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacher   String?
  campus    String?
  gradeLevel String?
  date      String?
  safetyAndManagement String?
  instantActivityWarmUp String?
  skillIntroduction String?
  skillPractice String?
  applicationActivity String?
  coolDownClosure String?
  assessment String?
  mvpa      String?
  adaptations String?
  teacherReflections String?
  isDraft   Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  
  resources LessonPlanResource[]
  
  @@map("lesson_plans")
}

model AdminLog {
  id        String     @id @default(cuid())
  action    String     // 'activate_code', 'upload_document', 'delete_user', etc.
  adminEmail String
  details   String     // JSON
  createdAt DateTime   @default(now())
  
  @@map("admin_logs")
}

model ClassPeriod {
  id              String     @id @default(cuid())
  teacherId       String
  teacher         Teacher    @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  periodNumber    Int        // 1, 2, 3, etc. (up to 7 for typical schedules)
  schoolYear      String     // e.g., "2025-2026"
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  // Relations
  studentAssignments StudentClassPeriodAssignment[]
  
  @@unique([teacherId, periodNumber, schoolYear])
  @@index([teacherId])
  @@map("class_periods")
}

model StudentClassPeriodAssignment {
  id              String     @id @default(cuid())
  studentId       String
  student         Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classPeriodId   String
  classPeriod     ClassPeriod @relation(fields: [classPeriodId], references: [id], onDelete: Cascade)
  schoolYear      String     // e.g., "2025-2026"
  semester        String?    // "Fall" or "Spring" (optional, can be used for semester-based tracking)
  enrollmentDate  DateTime   @default(now())
  dropDate        DateTime?  // null if still enrolled
  
  @@unique([studentId, classPeriodId, schoolYear])
  @@index([studentId])
  @@index([classPeriodId])
  @@map("student_class_period_assignments")
}

model Student {
  id                String     @id @default(cuid())
  districtId        String     @unique // unique identifier across schools
  firstName         String
  lastName          String
  sex               String     // M/F for FitnessGram standards
  dateOfBirth       DateTime
  currentGrade      Int        // 3-12
  currentSchool     String
  peTeacher         String
  classroomTeacher  String?    // classroom teacher (e.g., Mrs. Smith) - elementary only
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  // Relations
  fitnesGramTests   FitnesGramTest[]
  studentHistory    StudentHistory[]
  classroomPeriodAssignments StudentClassPeriodAssignment[] // secondary only
  
  @@index([districtId])
  @@index([currentSchool])
  @@index([classroomTeacher])
  @@map("students")
}

model FitnesGramTest {
  id                String     @id @default(cuid())
  studentId         String
  student           Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school            String
  testDate          DateTime
  testSeason        String     // 'Fall' or 'Spring'
  testYear          Int        // 2024, 2025, etc.
  
  // Test Metrics
  cardioTestType    String     @default("PACER")
  pacerOrMileRun    Float?     // PACER laps or mile time in minutes
  pushups           Int?
  situps            Int?
  sitAndReach       Float?     // flexibility test, distance in cm
  shoulderStretchRight Boolean? // pass/fail
  shoulderStretchLeft Boolean?  // pass/fail
  height            Float?     // in cm
  weight            Float?     // in kg
  bmi               Float?     // calculated from height/weight
  trunkLift         Float?     // distance in cm
  
  // Scoring
  healthZone        String?    // Healthy Fitness Zone or Needs Improvement
  percentile        Int?       // 1-99
  notes             String?
  
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  @@unique([studentId, testYear, testSeason])
  @@index([studentId])
  @@index([testYear, testSeason])
  @@map("fitnesgram_tests")
}

model StudentHistory {
  id                String     @id @default(cuid())
  studentId         String
  student           Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school            String
  enrollmentDate    DateTime
  exitDate          DateTime?
  grade             Int
  peTeacher         String
  
  createdAt         DateTime   @default(now())
  
  @@index([studentId])
  @@index([school])
  @@map("student_history")
}
